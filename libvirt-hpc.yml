# ansible-galaxy install stackhpc.libvirt-host
# Read: https://galaxy.ansible.com/stackhpc/libvirt-host
# Read: https://github.com/stackhpc/ansible-role-libvirt-host
- hosts: localhost
  connection: local

  name: Ensure that Libvirt is configured
  

  pre_tasks:
  
  - name: Create the logical volume on disk for VMs
    lvol:
      vg: fedora_fedora
      lv: vm-pool
      size: 100G
    tags:
    - lvm

  - name: Create the filesystem for VMs
    filesystem:
      fstype: xfs
      dev: /dev/fedora_fedora/vm-pool
    tags:
    - lvm

  - name: Mount the filesystem for VMs
    mount:
      path: /var/lib/libvirt/vm-pool
      src: /dev/fedora_fedora/vm-pool
      fstype: xfs
      state: mounted
      backup: yes
    tags:
    - lvm

  roles:
    - role: stackhpc.libvirt-host
      become: no
      libvirt_host_networks:
        - name: vm-network-routed
          mode: route
          bridge: virbr1
          domain: micro.local
          ip: 192.168.6.254
          netmask: 255.255.255.0
          dhcp_start: 192.168.6.100
          dhcp_end: 192.168.6.200
      libvirt_host_pools:
        - name: vm-pool
          type: dir
          #capacity: 1024
          path: /var/lib/libvirt/vm-pool
          mode: 755
          owner: qemu
          group: qemu
            #- name: vm-pool-lvm
            #type: logical
            #source: fedora_fedora
            #target: /dev/fedora_fedora
            #pvs:
            #- /dev/sdb3
